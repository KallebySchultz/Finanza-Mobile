<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama de Sequ√™ncia - Sistema Finanza</title>
    <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 2px solid #3498db;
            margin-top: 40px;
        }
        .diagram-container {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }
        .legend {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .legend h3 {
            color: #34495e;
            margin-top: 0;
        }
        .legend-item {
            display: inline-block;
            margin: 5px 10px;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
        }
        .user { background: #e3f2fd; border: 2px solid #1976d2; }
        .service { background: #e8f5e8; border: 2px solid #2e7d32; }
        .database { background: #fff8e1; border: 2px solid #f9a825; }
        .sync { background: #f3e5f5; border: 2px solid #7b1fa2; }
        .description {
            font-style: italic;
            color: #555;
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Diagrama de Sequ√™ncia - Sistema Finanza</h1>
        <p><strong>Fluxos de Intera√ß√£o - Mobile (Android) + Desktop (Java)</strong></p>
        
        <h2>1. Autentica√ß√£o de Usu√°rio</h2>
        <div class="description">
            <strong>Descri√ß√£o:</strong> Fluxo completo de autentica√ß√£o mostrando valida√ß√£o de credenciais, 
            gera√ß√£o de token de sess√£o e inicializa√ß√£o da sincroniza√ß√£o autom√°tica ap√≥s login bem-sucedido.
        </div>
        <div class="diagram-container">
            <div class="mermaid">
sequenceDiagram
    participant U as üë§ Usu√°rio
    participant MA as üì± Mobile App
    participant AS as üîê AuthService
    participant UD as üóÑÔ∏è UsuarioDAO
    participant DB as üóÉÔ∏è MySQL
    participant SS as üîÑ SyncService
    
    Note over U, SS: Fluxo de Autentica√ß√£o
    
    U->>MA: Informa email/senha
    activate MA
    
    MA->>AS: login(email, senha)
    activate AS
    
    AS->>UD: buscarPorEmail(email)
    activate UD
    
    UD->>DB: SELECT * FROM USUARIO WHERE email = ?
    activate DB
    DB-->>UD: Retorna dados do usu√°rio
    deactivate DB
    
    UD-->>AS: Usuario encontrado
    deactivate UD
    
    AS->>AS: validarSenha(senha, senhaHash)
    
    alt Senha v√°lida
        AS->>AS: gerarToken(usuario)
        AS->>AS: criarSessao(usuario)
        AS-->>MA: Login sucesso + token
        
        MA->>SS: iniciarSincronizacaoAutomatica()
        activate SS
        SS-->>MA: Sincroniza√ß√£o iniciada
        deactivate SS
        
        MA-->>U: Redireciona para Dashboard
    else Senha inv√°lida
        AS-->>MA: Erro de autentica√ß√£o
        MA-->>U: Exibe mensagem de erro
    end
    
    deactivate AS
    deactivate MA
            </div>
        </div>
        
        <h2>2. Adicionar Nova Transa√ß√£o (Mobile)</h2>
        <div class="description">
            <strong>Descri√ß√£o:</strong> Cria√ß√£o de nova transa√ß√£o no aplicativo mobile com persist√™ncia local 
            e marca√ß√£o para sincroniza√ß√£o posterior com o servidor.
        </div>
        <div class="diagram-container">
            <div class="mermaid">
sequenceDiagram
    participant U as üë§ Usu√°rio
    participant MA as üì± Mobile App
    participant TD as üí∞ TransacaoDAO
    participant LDB as üì± SQLite Local
    participant SS as üîÑ SyncService
    participant SD as üì° SyncData
    
    Note over U, SD: Cria√ß√£o de Transa√ß√£o no Mobile
    
    U->>MA: Preenche formul√°rio transa√ß√£o
    U->>MA: Clica "Salvar"
    activate MA
    
    MA->>MA: validarDados(transacao)
    
    alt Dados v√°lidos
        MA->>TD: inserir(transacao)
        activate TD
        
        TD->>LDB: INSERT INTO transacao VALUES (...)
        activate LDB
        LDB-->>TD: Sucesso na inser√ß√£o
        deactivate LDB
        
        TD-->>MA: Transa√ß√£o salva localmente
        deactivate TD
        
        MA->>SS: adicionarParaSincronizacao(transacao, "CREATE")
        activate SS
        
        SS->>SD: criar(tipo:"TRANSACAO", acao:"CREATE", dados:transacao)
        activate SD
        SD-->>SS: Registro de sync criado
        deactivate SD
        
        SS-->>MA: Adicionado √† fila de sincroniza√ß√£o
        deactivate SS
        
        MA-->>U: Transa√ß√£o salva com sucesso
    else Dados inv√°lidos
        MA-->>U: Exibe erros de valida√ß√£o
    end
    
    deactivate MA
            </div>
        </div>
        
        <h2>3. Processo de Sincroniza√ß√£o</h2>
        <div class="description">
            <strong>Descri√ß√£o:</strong> Sincroniza√ß√£o autom√°tica entre dispositivo mobile e servidor, 
            incluindo detec√ß√£o e resolu√ß√£o de conflitos de dados.
        </div>
        <div class="diagram-container">
            <div class="mermaid">
sequenceDiagram
    participant MA as üì± Mobile App
    participant SS as üîÑ SyncService
    participant SD as üì° SyncDataDAO
    participant NM as üåê NetworkManager
    participant SV as üñ•Ô∏è Servidor
    participant CR as ‚öñÔ∏è ConflictResolver
    
    Note over MA, CR: Processo de Sincroniza√ß√£o Autom√°tica
    
    MA->>SS: iniciarSincronizacao()
    activate SS
    
    SS->>NM: verificarConectividade()
    activate NM
    NM-->>SS: Conectividade OK
    deactivate NM
    
    SS->>SD: obterDadosPendentes()
    activate SD
    SD-->>SS: Lista de registros para sync
    deactivate SD
    
    loop Para cada registro pendente
        SS->>SV: enviarDados(dadosLocal)
        activate SV
        
        alt Sucesso sem conflito
            SV-->>SS: Confirma√ß√£o de recebimento
            SS->>SD: marcarComoSincronizado(uuid)
            
        else Conflito detectado
            SV-->>SS: Conflito + dadosServidor
            SS->>CR: resolverConflito(dadosLocal, dadosServidor)
            activate CR
            
            CR->>CR: aplicarEstrategiaResolucao()
            CR-->>SS: Dados resolvidos
            deactivate CR
            
            SS->>SV: reenviarDados(dadosResolvidos)
            SV-->>SS: Confirma√ß√£o final
            SS->>SD: marcarComoSincronizado(uuid)
        end
        
        deactivate SV
    end
    
    SS-->>MA: Sincroniza√ß√£o conclu√≠da
    deactivate SS
            </div>
        </div>
        
        <h2>4. Gera√ß√£o de Relat√≥rio (Desktop)</h2>
        <div class="description">
            <strong>Descri√ß√£o:</strong> Processo completo de gera√ß√£o de relat√≥rio financeiro na aplica√ß√£o desktop, 
            incluindo consulta aos dados, processamento e exporta√ß√£o em diferentes formatos.
        </div>
        <div class="diagram-container">
            <div class="mermaid">
sequenceDiagram
    participant U as üë§ Admin Desktop
    participant DT as üñ•Ô∏è Desktop UI
    participant RS as üìä RelatorioService
    participant TD as üí∞ TransacaoDAO
    participant MySQL as üóÉÔ∏è MySQL
    participant EX as üìÑ ExportService
    participant FS as üìÅ FileSystem
    
    Note over U, FS: Gera√ß√£o de Relat√≥rio Financeiro
    
    U->>DT: Acessa tela de relat√≥rios
    DT->>DT: carregarParametros()
    DT-->>U: Exibe formul√°rio de relat√≥rio
    
    U->>DT: Define per√≠odo e filtros
    U->>DT: Clica "Gerar Relat√≥rio"
    activate DT
    
    DT->>RS: gerarRelatorio(parametros)
    activate RS
    
    RS->>TD: consultarTransacoes(filtros)
    activate TD
    
    TD->>MySQL: SELECT com JOINs e filtros
    activate MySQL
    MySQL-->>TD: Dados das transa√ß√µes
    deactivate MySQL
    
    TD-->>RS: Lista de transa√ß√µes
    deactivate TD
    
    RS->>RS: processarDados(transacoes)
    RS->>RS: calcularTotais()
    RS->>RS: agruparPorCategoria()
    
    RS->>EX: exportar(dados, formato)
    activate EX
    
    alt Formato PDF
        EX->>EX: gerarPDF(dados)
        EX->>FS: salvarArquivo(pdf, caminho)
    else Formato Excel
        EX->>EX: gerarExcel(dados)
        EX->>FS: salvarArquivo(excel, caminho)
    else Formato CSV
        EX->>EX: gerarCSV(dados)
        EX->>FS: salvarArquivo(csv, caminho)
    end
    
    FS-->>EX: Arquivo salvo
    EX-->>RS: Caminho do arquivo
    deactivate EX
    
    RS->>RS: criarRegistroRelatorio(parametros, caminho)
    RS-->>DT: Relat√≥rio gerado com sucesso
    deactivate RS
    
    DT-->>U: Exibe link para download
    
    U->>DT: Clica para baixar
    DT->>FS: abrirArquivo(caminho)
    FS-->>U: Download do relat√≥rio
    
    deactivate DT
            </div>
        </div>
        
        <div class="legend">
            <h3>üé® Legenda dos Participantes:</h3>
            <div class="legend-item user">üë§ Usu√°rios e Interfaces</div>
            <div class="legend-item service">üîß Servi√ßos e L√≥gica de Neg√≥cio</div>
            <div class="legend-item database">üíæ Persist√™ncia e Dados</div>
            <div class="legend-item sync">üîÑ Sincroniza√ß√£o e Rede</div>
        </div>
        
        <div class="legend">
            <h3>üìä An√°lise dos Fluxos:</h3>
            <ul>
                <li><strong>Autentica√ß√£o:</strong> 2-3 segundos para login completo</li>
                <li><strong>Transa√ß√£o Mobile:</strong> Persist√™ncia local instant√¢nea + sync em background</li>
                <li><strong>Sincroniza√ß√£o:</strong> Autom√°tica a cada 30 segundos ou manual</li>
                <li><strong>Relat√≥rios:</strong> 5-15 segundos dependendo do volume de dados</li>
                <li><strong>Resolu√ß√£o de Conflitos:</strong> 3 estrat√©gias (local, remoto, merge)</li>
            </ul>
        </div>
        
        <div class="legend">
            <h3>üéØ Padr√µes de Design Identificados:</h3>
            <ul>
                <li><strong>Command Pattern:</strong> Opera√ß√µes offline encapsuladas como comandos</li>
                <li><strong>Observer Pattern:</strong> Notifica√ß√µes de mudan√ßas de estado</li>
                <li><strong>Strategy Pattern:</strong> M√∫ltiplas estrat√©gias de resolu√ß√£o de conflitos</li>
                <li><strong>Chain of Responsibility:</strong> Pipeline de valida√ß√µes e processamento</li>
                <li><strong>Repository Pattern:</strong> Abstra√ß√£o da camada de persist√™ncia</li>
            </ul>
        </div>
        
        <div class="legend">
            <h3>üõ°Ô∏è Tratamento de Erros:</h3>
            <ul>
                <li><strong>Autentica√ß√£o:</strong> Valida√ß√£o de credenciais + bloqueio ap√≥s tentativas</li>
                <li><strong>Transa√ß√µes:</strong> Valida√ß√µes de neg√≥cio + rollback autom√°tico</li>
                <li><strong>Sincroniza√ß√£o:</strong> Retry autom√°tico + queue de dados offline</li>
                <li><strong>Relat√≥rios:</strong> Timeout configur√°vel + cache de resultados</li>
            </ul>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            sequence: {
                useMaxWidth: true,
                htmlLabels: true,
                wrap: true,
                width: 150
            }
        });
    </script>
</body>
</html>